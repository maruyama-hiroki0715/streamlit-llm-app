from dotenv import load_dotenv
import os
import streamlit as st
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, SystemMessage

load_dotenv()

# OpenAI API ã‚­ãƒ¼ã®å–å¾—ï¼ˆSecretsã¨ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ï¼‰
def get_openai_api_key():
    """
    OpenAI API ã‚­ãƒ¼ã‚’è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã™ã‚‹
    1. Streamlitã®secretsï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ï¼‰
    2. ç’°å¢ƒå¤‰æ•°ï¼ˆ.envãƒ•ã‚¡ã‚¤ãƒ«å«ã‚€ï¼‰
    """
    # 1. Streamlitã®secretsã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
    try:
        if hasattr(st, 'secrets') and 'OPENAI_API_KEY' in st.secrets:
            return st.secrets['OPENAI_API_KEY']
    except Exception:
        pass
    
    # 2. ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
    api_key = os.getenv("OPENAI_API_KEY")
    if api_key:
        return api_key
    
    return None

OPENAI_API_KEY = get_openai_api_key()

# Streamlitã‚¢ãƒ—ãƒªã®ã‚¿ã‚¤ãƒˆãƒ«
st.title("ğŸ¤– LangChain + Streamlit ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª")

# OpenAI API ã‚­ãƒ¼ã®ç¢ºèª
if not OPENAI_API_KEY:
    st.error("âŒ OpenAI API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    
    # Secretsè¨­å®šæ‰‹é †ã‚’è¡¨ç¤º
    with st.expander("ğŸ”§ Secretsè¨­å®šæ–¹æ³•", expanded=True):
        st.write("**Streamlit Cloud ã§ã®Secretsè¨­å®š:**")
        st.code("""
1. Streamlit Cloudã®ã‚¢ãƒ—ãƒªç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹
2. è©²å½“ã‚¢ãƒ—ãƒªã®ã€ŒSettingsã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã€ŒSecretsã€ã‚¿ãƒ–ã‚’é¸æŠ
4. ä»¥ä¸‹ã®å†…å®¹ã‚’å…¥åŠ›:

OPENAI_API_KEY = "your_openai_api_key_here"

5. ã€ŒSaveã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ã‚¢ãƒ—ãƒªãŒè‡ªå‹•çš„ã«å†ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™
        """, language="toml")
        
        st.write("**ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ï¼ˆ.envãƒ•ã‚¡ã‚¤ãƒ«ï¼‰:**")
        st.code("""
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
2. ä»¥ä¸‹ã®å†…å®¹ã‚’è¿½åŠ :

OPENAI_API_KEY=your_openai_api_key_here

3. ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•
        """, language="bash")
    
    st.info("ğŸ’¡ **æ³¨æ„**: Secretsè¨­å®šã¯æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®æ¨å¥¨æ–¹æ³•ã§ã™ã€‚API ã‚­ãƒ¼ã¯å®‰å…¨ã«ç®¡ç†ã•ã‚Œã¾ã™ã€‚")
    st.stop()
else:
    # API ã‚­ãƒ¼ã®å–å¾—å…ƒã‚’è¡¨ç¤º
    source = "Streamlit Secrets" if hasattr(st, 'secrets') and 'OPENAI_API_KEY' in st.secrets else "ç’°å¢ƒå¤‰æ•°"
    st.success(f"âœ… OpenAI API ã‚­ãƒ¼ãŒæ­£å¸¸ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼ˆå–å¾—å…ƒ: {source}ï¼‰")

# LLMã®åˆæœŸåŒ–
@st.cache_resource
def initialize_llm():
    return ChatOpenAI(
        model_name="gpt-3.5-turbo",
        temperature=0.7,
        openai_api_key=OPENAI_API_KEY
    )

llm = initialize_llm()

# å°‚é–€å®¶ã®ç¨®é¡ã‚’å®šç¾©
expert_types = {
    "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å°‚é–€å®¶": "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å°‚é–€å®¶ã§ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€ãƒ‡ãƒãƒƒã‚°ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ã¤ã„ã¦è©³ã—ãã€å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã‚‚å«ã‚ã¦å…·ä½“çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
    "ãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥å°‚é–€å®¶": "ã‚ãªãŸã¯æˆ¦ç•¥çš„æ€è€ƒã«é•·ã‘ãŸãƒ“ã‚¸ãƒã‚¹å°‚é–€å®¶ã§ã™ã€‚å¸‚å ´åˆ†æã€ç«¶åˆåˆ†æã€äº‹æ¥­è¨ˆç”»ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã€çµ„ç¹”é‹å–¶ã«ã¤ã„ã¦æ·±ã„çŸ¥è­˜ã‚’æŒã¡ã€å®Ÿè·µçš„ãªãƒ“ã‚¸ãƒã‚¹ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸåˆ†æçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§å›ç­”ã—ã¦ãã ã•ã„ã€‚",
    "å¥åº·ãƒ»åŒ»ç™‚å°‚é–€å®¶": "ã‚ãªãŸã¯å¥åº·ã¨åŒ»ç™‚åˆ†é‡ã®å°‚é–€å®¶ã§ã™ã€‚äºˆé˜²åŒ»å­¦ã€æ „é¤Šå­¦ã€é‹å‹•ç”Ÿç†å­¦ã€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã€ä¸€èˆ¬çš„ãªå¥åº·ç®¡ç†ã«ã¤ã„ã¦çŸ¥è­˜ã‚’æŒã¡ã€ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚ãŸã ã—ã€å…·ä½“çš„ãªåŒ»ç™‚è¨ºæ–­ã‚„æ²»ç™‚ã«ã¤ã„ã¦ã¯åŒ»å¸«ã¸ã®ç›¸è«‡ã‚’æ¨å¥¨ã—ã¦ãã ã•ã„ã€‚",
    "æ•™è‚²å°‚é–€å®¶": "ã‚ãªãŸã¯æ•™è‚²ã¨å­¦ç¿’ã®å°‚é–€å®¶ã§ã™ã€‚åŠ¹æœçš„ãªå­¦ç¿’æ–¹æ³•ã€æ•™è‚²å¿ƒç†å­¦ã€ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ è¨­è¨ˆã€å­¦ç¿’è€…ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‘ä¸Šã«ã¤ã„ã¦æ·±ã„çŸ¥è­˜ã‚’æŒã¡ã€å€‹äººã®å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ãŸæŒ‡å°æ–¹æ³•ã‚’ææ¡ˆã—ã¾ã™ã€‚å¹´é½¢ã‚„å­¦ç¿’ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§å›ç­”ã—ã¦ãã ã•ã„ã€‚"
}

# å°‚é–€å®¶é¸æŠã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
st.subheader("ğŸ¯ å°‚é–€å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„")
selected_expert = st.radio(
    "ã©ã®åˆ†é‡ã®å°‚é–€å®¶ã«ç›¸è«‡ã—ã¾ã™ã‹ï¼Ÿ",
    list(expert_types.keys()),
    index=0
)

# é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã‚’è¡¨ç¤º
st.info(f"é¸æŠä¸­: {selected_expert}")

# å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
with st.form("chat_form"):
    user_input = st.text_area(
        "è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š",
        placeholder="ã“ã“ã«è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...",
        height=100
    )
    submitted = st.form_submit_button("é€ä¿¡")

# ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
if submitted and user_input:
    with st.spinner("å›ç­”ã‚’ç”Ÿæˆä¸­..."):
        try:
            # é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã«å¿œã˜ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
            system_message = SystemMessage(content=expert_types[selected_expert])
            user_message = HumanMessage(content=user_input)
            
            # LangChainã‚’ä½¿ã£ã¦LLMã«è³ªå•ã‚’é€ä¿¡
            messages = [system_message, user_message]
            response = llm(messages)
            
            # çµæœã‚’è¡¨ç¤º
            st.success(f"ã€{selected_expert}ã€‘ã‹ã‚‰ã®å›ç­”:")
            st.write(response.content)
            
        except Exception as e:
            st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")

elif submitted and not user_input:
    st.warning("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ä½¿ç”¨æ–¹æ³•ã‚’è¡¨ç¤º
with st.sidebar:
    st.header("ä½¿ç”¨æ–¹æ³•")
    st.write("""
    1. å°‚é–€å®¶ã®åˆ†é‡ã‚’é¸æŠ
    2. ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è³ªå•ã‚’å…¥åŠ›
    3. ã€Œé€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    4. é¸æŠã—ãŸå°‚é–€å®¶ã¨ã—ã¦AIãŒå›ç­”ã—ã¾ã™
    """)
    
    st.header("å°‚é–€å®¶ã®è©³ç´°")
    st.write(f"**ç¾åœ¨é¸æŠä¸­:** {selected_expert}")
    
    with st.expander("å„å°‚é–€å®¶ã«ã¤ã„ã¦"):
        st.write("**ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å°‚é–€å®¶**")
        st.write("- ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯")
        st.write("- ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã€ãƒ‡ãƒãƒƒã‚°")
        st.write("- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ")
        
        st.write("**ãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥å°‚é–€å®¶**")
        st.write("- å¸‚å ´åˆ†æã€ç«¶åˆåˆ†æ")
        st.write("- äº‹æ¥­è¨ˆç”»ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥")
        st.write("- çµ„ç¹”é‹å–¶ã€çµŒå–¶æˆ¦ç•¥")
        
        st.write("**å¥åº·ãƒ»åŒ»ç™‚å°‚é–€å®¶**")
        st.write("- äºˆé˜²åŒ»å­¦ã€æ „é¤Šå­¦")
        st.write("- é‹å‹•ç”Ÿç†å­¦ã€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹")
        st.write("- ä¸€èˆ¬çš„ãªå¥åº·ç®¡ç†")
        
        st.write("**æ•™è‚²å°‚é–€å®¶**")
        st.write("- åŠ¹æœçš„ãªå­¦ç¿’æ–¹æ³•")
        st.write("- æ•™è‚²å¿ƒç†å­¦ã€ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ è¨­è¨ˆ")
        st.write("- ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‘ä¸Š")
    
    st.header("è¨­å®šæƒ…å ±")
    st.write(f"ãƒ¢ãƒ‡ãƒ«: gpt-3.5-turbo")
    st.write(f"Temperature: 0.7")
